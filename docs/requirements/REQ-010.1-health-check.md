# REQ-010.1: MCP Server Health Check & Configuration Test

**Version:** 1.0
**Date:** 2025-11-23
**Parent:** REQ-010 (MCP Server Implementation)
**Type:** Enhancement / Bug Fix
**Priority:** HIGH

---

## Problem Statement

After implementing REQ-010, users reported:
1. ❌ No automated way to verify MCP server installation
2. ❌ No test for MCP server configuration
3. ❌ install.sh doesn't verify MCP server was built correctly
4. ❌ No automated configuration for AI agents (OpenCode, Claude Desktop)

**User Feedback:**
> "funktioniert nicht - ich sehe keine Konfiguration in opencode.json nach der Installation"

---

## Requirements

### 1. MCP Server Configuration Test (Unit Test)
**REQ-010.1.1:** Add unit test that validates MCP server configuration
- ✅ Test that server starts correctly
- ✅ Test that all 7 tools are registered
- ✅ Test that stdio transport works
- ✅ Test that configuration discovery works

### 2. Installation Health Check
**REQ-010.1.2:** Extend install.sh with MCP server health check
- ✅ Verify mcp-server directory exists
- ✅ Verify npm dependencies installed
- ✅ Verify TypeScript compilation successful (dist/ exists)
- ✅ Verify all 7 tools present in dist/
- ✅ Run npm test and verify all tests pass
- ✅ Test server startup (node dist/index.js --version or similar)

### 3. Configuration File Generation
**REQ-010.1.3:** Auto-generate AI agent configuration
- ✅ Detect which AI agents are installed (Claude Desktop, OpenCode, Zed, etc.)
- ✅ Generate appropriate config snippet for each
- ✅ Optionally auto-insert into config files (with user permission)
- ✅ At minimum: Print configuration instructions to user

### 4. Configuration Validation Test
**REQ-010.1.4:** Add test that validates generated configuration
- ✅ Test config.json/opencode.json format is valid
- ✅ Test paths in configuration exist
- ✅ Test environment variables are correct

---

## Acceptance Criteria

### Installation Success Criteria
After running `./install.sh`, user should see:
```
✓ MCP Server installed: /home/user/mcp_pdftools/mcp-server
✓ Dependencies installed: 451 packages
✓ TypeScript compiled: dist/ directory created
✓ All tests passed: 22/22
✓ Server startup test: OK

Configuration Instructions:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
For OpenCode, add to ~/.config/opencode/opencode.json:

{
  "mcp": {
    "pdftools": {
      "type": "local",
      "command": ["node", "/home/user/mcp_pdftools/mcp-server/dist/index.js"],
      "enabled": true,
      "environment": {
        "MCP_PDFTOOLS_VENV": "/home/user/mcp_pdftools/venv/bin/python"
      },
      "timeout": 300000
    }
  }
}

Would you like to add this configuration automatically? [y/N]
```

### Test Success Criteria
New test should verify:
```bash
npm test
# Should include:
# - 22 existing security tests (PASS)
# - 1 MCP server configuration test (PASS)
# - Total: 23/23 tests passing
```

---

## Implementation Tasks

### Task 1: MCP Server Configuration Test
**File:** `mcp-server/tests/integration/server.test.ts` (new)
**Estimated Time:** 30 minutes

Test should:
1. Start MCP server
2. Send list_tools request
3. Verify 7 tools registered
4. Send test tool call (pdf_merge with invalid params)
5. Verify error handling works
6. Shutdown server

### Task 2: Health Check Script
**File:** `scripts/health_check_mcp.sh` (new)
**Estimated Time:** 45 minutes

Script should:
1. Check mcp-server/ exists
2. Check dist/ exists
3. Run npm test
4. Test server startup
5. Exit with code 0 (success) or 1 (failure)

### Task 3: Install.sh Enhancement
**File:** `install.sh` (modify)
**Estimated Time:** 30 minutes

Add new step:
```bash
Step 11/11: MCP Server Health Check
- Running health check script...
- ✓ All checks passed
```

### Task 4: Configuration Generator
**File:** `scripts/generate_mcp_config.sh` (new)
**Estimated Time:** 1 hour

Script should:
1. Detect AI agent configs:
   - ~/.config/opencode/opencode.json
   - ~/.config/claude/config.json
   - ~/.config/zed/settings.json
2. Generate config snippet for each
3. Ask user if they want to auto-insert
4. If yes: backup existing config, insert new config
5. If no: print instructions

---

## Testing Plan

### Unit Tests
- ✅ `tests/integration/server.test.ts` - MCP server startup and tool registration
- ✅ `tests/integration/config.test.ts` - Configuration validation

### Integration Tests
- ✅ Run install.sh and verify health check passes
- ✅ Run health check script standalone
- ✅ Run config generator and verify output

### Manual Tests
- ✅ Install on fresh system, verify health check
- ✅ Test with OpenCode (verify tools appear)
- ✅ Test with Claude Desktop (verify tools appear)

---

## Success Metrics

| Metric | Target | Verification |
|--------|--------|--------------|
| Installation success rate | > 95% | User feedback |
| Health check pass rate | 100% | Automated test |
| Config generation accuracy | 100% | Manual review |
| User confusion reduction | < 5% users need help | Support tickets |

---

## Risks & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Auto-config overwrites user settings | MEDIUM | HIGH | Always backup, ask permission |
| Health check fails on valid install | LOW | MEDIUM | Thorough testing across platforms |
| Config paths wrong for different systems | MEDIUM | HIGH | Test on Linux, macOS, Windows/WSL |

---

## Timeline

- **Requirement Documentation:** 15 minutes ✅
- **Implementation:** 2.5 hours
  - Task 1: 30 min
  - Task 2: 45 min
  - Task 3: 30 min
  - Task 4: 60 min
- **Testing:** 30 minutes
- **Documentation:** 15 minutes
- **Commit & Push:** 5 minutes

**Total:** ~3 hours

---

## Related Documents

- REQ-010: MCP Server Implementation (parent)
- DESIGN-010: MCP Server Design
- TEST-010-v1.0: Test Report (needs update)
- install.sh: Installation script (needs update)

---

## Notes

This enhancement addresses critical usability issues discovered during acceptance testing. It ensures:
1. **Installation verification** - Users know if installation succeeded
2. **Configuration assistance** - Users get working config without manual editing
3. **Troubleshooting support** - Health check helps diagnose issues

**Impact:** This should reduce "installation doesn't work" reports to near zero.
